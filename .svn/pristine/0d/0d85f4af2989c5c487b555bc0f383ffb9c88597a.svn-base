<?php
/*
Author by: Mark E Taylor
Created: 21/10/2013
Last updated: 21/10/2013

Revision history: 
21/10/2013 - Initial creation.

Description: Saves an edited report and returns to the summary page (index.php).
*/

include_once("library/config.php");
include_once("library/open.php");
include_once("load_config.php");

if(SAVE_REPORT){
	echo "<p>Debug turned on, so the edited report will not be saved to the database.</p>";
	echo "Edited report name: $newreportname.<br/>";
	echo "Edited report number: $_POST[reportnumber].<br/>";
}

/* **** The reports table. **** */
$reports_query = "UPDATE INTO ".REPORTS_TABLE." (report_number, report_name, select_statement, select_parameter1, select_parameter2, select_parameter3, displayorder) VALUE ('$_POST[reportnumber]', '$newreportname', '$_POST[select]', '$_POST[parameter1]', '$_POST[parameter2]', '$_POST[parameter3]', '$nextdisplayorder')";

/* Update the reports table. Only if SAVE_REPORT=0. */
if(SAVE_REPORT){
		echo "<p>Reports table.</p>";
		echo $reports_query."<br/>";
		echo "The '".REPORTS_TABLE."' table was not updated.<br/>";
} else {
		$result = $database_object->query($reports_query);	
}

/* **** The headers table. **** */
$display_order = 1;
foreach($_POST['header'] as $value){
	$headers_query = "UPDATE INTO ".REPORT_HEADER_TABLE." (report_number, header_name, header_order, comment) VALUE('$_POST[reportnumber]', '$value', '$display_order', '$newreportname')";
	$display_order = $display_order + 1;
	
/* Update the report_header table. Only if SAVE_REPORT=0. */
	if(SAVE_REPORT){
		echo "<p>Headers table.</p>";
		echo $headers_query."<br/>";
		echo "The '".REPORT_HEADER_TABLE."' table was not updated.<br/>";
	} else {
		$result = $database_object->query($headers_query);		
	}
}

/* **** The cells table. **** */
$cell_order = 1;
foreach($_POST['cell'] as $value){
	$coded_value = htmlspecialchars($value);
	$cells_query = "UPDATE INTO ".REPORT_CELLS_TABLE." (report_number, cell_format, cell_order, comment) VALUE('$_POST[reportnumber]', '$coded_value', '$cell_order', '$newreportname')";
	$cell_order = $cell_order + 1;
	
/* Update the report_cells table. Only if SAVE_REPORT=0. */
	if(SAVE_REPORT){
		echo "<p>Cells table.</p>";
		echo $cells_query."<br/>";
		echo "The '".REPORT_CELLS_TABLE."' table was not updated.<br/>";
	} else {
		$result = $database_object->query($cells_query);		
	}
}

/* Exit early if SAVE_REPORT=1. */
if(SAVE_REPORT){
		echo "<br/>Exiting early!";
		exit(99);
	} else {
		include_once("library/close.php");
		header('location: index.php');
	}
?>